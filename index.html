<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED-SECURE Chat</title>
    <script src="https://cdn.tailwindcss.com"></script> 

    </head>
            
ย <style>
ย ย ย ย @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
ย ย ย ย body {
ย ย ย ย ย ย font-family: 'Inter', sans-serif;
ย ย ย ย ย ย background-color: #0d1117; /* Fondo oscuro tipo terminal */
ย ย ย ย ย ย color: #c9d1d9;
ย ย ย ย ย ย min-height: 100vh; /* CRรTICO: Asegura que el body ocupe el 100% de la altura de la ventana */
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย }
ย ย ย ย .container {
ย ย ย ย ย ย max-width: 480px;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย /* AJUSTE CRรTICO: Usar 100% de la altura disponible, ya que el body tiene min-height: 100vh */
ย ย ย ย ย ย height: 100%; 
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-direction: column;
ย ย ย ย ย ย background-color: #161b22;
ย ย ย ย ย ย box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
ย ย ย ย ย ย border: 1px solid #30363d;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย overflow: hidden;
ย ย ย ย }
ย ย ย ย /* Aseguramos que main, donde estรก la setupScreen, use el espacio flexible */
ย ย ย ย .container main {
ย ย ย ย ย ย flex-grow: 1; 
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-direction: column;
ย ย ย ย ย ย height: 100%; /* Asegura que el main use toda la altura flexible */
ย ย ย ย }
ย ย ย ย .chat-area {
ย ย ย ย ย ย flex-grow: 1;
ย ย ย ย ย ย overflow-y: auto;
ย ย ย ย ย ย padding: 16px;
ย ย ย ย ย ย scroll-behavior: smooth;
ย ย ย ย }
ย ย ย ย .message-bubble {
ย ย ย ย ย ย max-width: 80%;
ย ย ย ย ย ย padding: 10px 14px;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย margin-bottom: 8px;
ย ย ย ย ย ย word-wrap: break-word;
ย ย ย ย }
ย ย ย ย .sent {
ย ย ย ย ย ย background-color: #1f6feb;
ย ย ย ย ย ย align-self: flex-end;
ย ย ย ย ย ย margin-left: auto;
ย ย ย ย ย ย border-bottom-right-radius: 4px;
ย ย ย ย }
ย ย ย ย .received {
ย ย ย ย ย ย background-color: #21262d;
ย ย ย ย ย ย align-self: flex-start;
ย ย ย ย ย ย margin-right: auto;
ย ย ย ย ย ย border: 1px solid #30363d;
ย ย ย ย ย ย border-bottom-left-radius: 4px;
ย ย ย ย }
ย ย ย ย input[type="number"]::-webkit-inner-spin-button,
ย ย ย ย input[type="number"]::-webkit-outer-spin-button {
ย ย ย ย ย ย -webkit-appearance: none;
ย ย ย ย ย ย margin: 0;
ย ย ย ย }
ย ย ย ย .system-alert {
ย ย ย ย ย ย background-color: #ff0000;
ย ย ย ย ย ย color: #ffffff;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย padding: 8px 12px;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย margin: 10px auto;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย animation: pulse-red 1s infinite alternate;
ย ย ย ย }
ย ย ย ย @keyframes pulse-red {
ย ย ย ย ย ย from { opacity: 0.8; }
ย ย ย ย ย ย to { opacity: 1; }
ย ย ย ย }
ย ย ย ย .loader {
ย ย ย ย ย ย border-color: #58a6ff;
ย ย ย ย ย ย border-top-color: transparent;
ย ย ย ย ย ย animation: spin 1s linear infinite;
ย ย ย ย }
ย ย ย ย @keyframes spin {
ย ย ย ย ย ย 0% { transform: rotate(0deg); }
ย ย ย ย ย ย 100% { transform: rotate(360deg); }
ย ย ย ย }
ย ย </style>
            
</head>
<body>

ย ย <div class="container" id="appContainer">

ย ย ย ย <header class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#1a1f26]">
ย ย ย ย ย ย <h1 class="text-xl font-bold text-[#58a6ff]">:: RED-SECURE ::</h1>
ย ย ย ย ย ย <div id="headerControls" class="flex space-x-2">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย </header>

<main class="flex-grow p-4 overflow-hidden relative">
    
    <div id="setupScreen" class="absolute inset-0 bg-[#161b22] z-40 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        </div>
    
    </main>

ย ย ย ย ย ย <div id="setupScreen" class="absolute inset-0 bg-[#161b22] z-40 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
ย ย ย ย ย ย ย ย <div class="p-8 bg-[#21262d] rounded-xl w-full max-w-sm shadow-lg border border-[#30363d]">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold mb-6 text-center text-[#58a6ff]">Establecer Conexiรณn รnica</h2>

ย ย ย ย ย ย ย ย <div id="roleSelection">
    <p class="mb-4 text-center">ยฟEres quien **genera** el cรณdigo o quien lo **ingresa**?</p>
    <button onclick="setRole('host')" class="w-full bg-[#30363d] text-white py-3 rounded-lg font-semibold hover:bg-[#4a5057] transition duration-200 mb-3">
        Generar Cรณdigo (HOST)
    </button>
    <button onclick="setRole('client')" class="w-full bg-[#30363d] text-white py-3 rounded-lg font-semibold hover:bg-[#4a5057] transition duration-200">
        Ingresar Cรณdigo (CLIENTE)
    </button>
</div>
                    
                    <div id="hostArea" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-3 text-center text-sm text-gray-400">Paso 1: Define tu PIN de 4 dรญgitos para futuros accesos.</p>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="hostPinInput" placeholder="PIN de 4 dรญgitos" maxlength="4" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="setupPinAndGenerateCode()" class="w-full bg-[#1f6feb] text-white py-3 rounded-lg font-semibold hover:bg-[#1a55b3] transition duration-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Guardar PIN y Generar Cรณdigo รnico
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="hostWaitingArea" class="hidden text-center mt-6">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-yellow-400 mb-2 font-semibold">CรDIGO รNICO GENERADO (COMPARTIR SOLO UNA VEZ):</p>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="p-3 bg-[#0d1117] rounded-lg border border-yellow-700 flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <code id="displayCode" class="text-xl font-mono tracking-wider text-yellow-300 select-all">...</code>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="copyToClipboard(document.getElementById('displayCode').innerText)" class="ml-3 text-gray-400 hover:text-white transition duration-150">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-8-7l-4 4m0 0l4 4m-4-4h12"/></svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-400 mb-4">Esperando que el Cliente ingrese este cรณdigo...</p>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-4 inline-block"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="cancelConnectionAndReset()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200 mt-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Cancelar y Generar Nuevo Cรณdigo
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="clientArea" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-3 text-center text-sm text-gray-400">Paso 1: Define tu PIN de 4 dรญgitos para futuros accesos.</p>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="clientPinInput" placeholder="PIN de 4 dรญgitos" maxlength="4" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-3 text-center text-sm text-gray-400">Paso 2: Ingresa el Cรณdigo รnico de 12 caracteres proporcionado.</p>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="joinCodeInput" placeholder="Cรณdigo รnico de 12 caracteres" maxlength="12" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg tracking-wider uppercase focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="this.value = this.value.toUpperCase();">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="setupPinAndJoinRoom()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Conectar y Unirse al Chat
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย <p id="joinError" class="text-sm text-red-400 mt-3 text-center hidden">No se pudo encontrar el cรณdigo o la sala.</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
            
            ย ย ย ย ย ย <div id="chatScreen" class="h-full flex flex-col transition-opacity duration-300 hidden">
ย ย ย ย ย ย ย ย <div id="chatArea" class="chat-area flex flex-col">
                    ย ย ย ย ย ย ย ย </div>
                ย ย ย ย ย ย </div>

            ย ย ย ย </main>

          
ย ย ย ย ย ย <div id="chatScreen" class="h-full flex flex-col transition-opacity duration-300 hidden">
ย ย ย ย ย ย ย ย <div id="chatArea" class="chat-area flex flex-col">
ย ย ย ย ย ย ย ย ย ย <div class="system-alert mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย Conexiรณn establecida. Cifrado AES-GCM 256 activo.
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="p-4 border-t border-gray-700 bg-[#1a1f26]">
ย ย ย ย ย ย ย ย ย ย <div class="flex space-x-2">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." class="flex-grow p-3 rounded-lg bg-[#0d1117] border border-[#30363d] text-white focus:ring-[#58a6ff] focus:border-[#58a6ff]" onkeypress="if(event.key === 'Enter') sendMessage()">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="sendMessage()" class="bg-[#58a6ff] text-white px-4 py-3 rounded-lg font-semibold hover:bg-[#4a8ce6] transition duration-200 flex-shrink-0">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Enviar
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div id="customAlert" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[9999] flex items-center justify-center">
ย ย ย ย ย ย ย ย <div class="bg-[#21262d] p-6 rounded-xl shadow-2xl border border-[#30363d] w-full max-w-sm">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-red-400 mb-4" id="alertTitle">Alerta</h3>
ย ย ย ย ย ย ย ย ย ย <p class="text-gray-300 mb-6" id="alertMessage">Mensaje de alerta.</p>
ย ย ย ย ย ย ย ย ย ย <button onclick="document.getElementById('customAlert').classList.add('hidden')" class="w-full bg-[#58a6ff] text-white py-2 rounded-lg font-semibold hover:bg-[#4a8ce6]">
ย ย ย ย ย ย ย ย ย ย ย ย Aceptar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย </main>
ย ย </div>

ย ย <script type="module">
ย ย ย ย // --- 1. Importaciones de Firebase (CORREGIDO: Eliminada la importaciรณn duplicada) ---
ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
ย ย ย ย import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
ย ย ย ย import { getFirestore, doc, onSnapshot, collection, query, orderBy, setDoc, addDoc, serverTimestamp, deleteDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


ย ย ย ย // --- 2. Configuraciรณn de Firebase ---
ย ย ย ย // Tu configuraciรณn de Firebase
ย ย ย ย const firebaseConfig = {
ย ย ย ย ย ย apiKey: "AIzaSyA65iS3AUpfOGeZ_Vmi-DZXD1UHDO9l3s0",
ย ย ย ย ย ย authDomain: "chat-app-f6527.firebaseapp.com",
ย ย ย ย ย ย projectId: "chat-app-f6527",
ย ย ย ย ย ย storageBucket: "chat-app-f6527.firebasestorage.app",
ย ย ย ย ย ย messagingSenderId: "411702105463",
ย ย ย ย ย ย appId: "1:411702105463:web:66a0c6bc69559cf190bd72"
ย ย ย ย };
ย ย ย
ย ย ย ย // Inicializar Firebase y Servicios
ย ย ย ย const app = initializeApp(firebaseConfig);
ย ย ย ย const auth = getAuth(app);ย
ย ย ย ย const db = getFirestore(app);ย
ย ย ย ย const appId = firebaseConfig.appId; // Para usar en deriveKey
ย ย ย ย setLogLevel('error');ย

ย ย ย ย // Variables de Estado Global
ย ย ย ย let userId = null;ย
ย ย ย ย let roomId = null;ย
ย ย ย ย let symmetricKey = null;ย
ย ย ย ย let pinHash = null;ย
ย ย ย ย let messagesUnsubscribe = null;
ย ย ย ย let roomUnsubscribe = null;

ย ย ย ย // --- Criptografรญa (Web Crypto API) ---

ย ย ย ย /**
ย ย ย ย ย* Deriva la clave simรฉtrica AES-GCM 256-bit usando PBKDF2.
ย ย ย ย ย* @param {string} code El cรณdigo de 12 caracteres (PSK).
ย ย ย ย ย* @returns {Promise<CryptoKey>} La clave CryptoKey.
ย ย ย ย ย*/
ย ย ย ย async function deriveKey(code) {
ย ย ย ย ย ย const encoder = new TextEncoder();
ย ย ย ย ย ย // Usar el ID de la app como salt fijo (no es ideal, pero simplifica el intercambio)
ย ย ย ย ย ย const salt = encoder.encode(appId);ย
ย ย ย ย ย ย const keyMaterial = await crypto.subtle.importKey(
ย ย ย ย ย ย ย ย "raw",
ย ย ย ย ย ย ย ย encoder.encode(code),
ย ย ย ย ย ย ย ย { name: "PBKDF2" },
ย ย ย ย ย ย ย ย false,
ย ย ย ย ย ย ย ย ["deriveKey"]
ย ย ย ย ย ย );

ย ย ย ย ย ย return crypto.subtle.deriveKey(
ย ย ย ย ย ย ย ย {
ย ย ย ย ย ย ย ย ย ย name: "PBKDF2",
ย ย ย ย ย ย ย ย ย ย salt: salt,
ย ย ย ย ย ย ย ย ย ย iterations: 100000,
ย ย ย ย ย ย ย ย ย ย hash: "SHA-256",
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย keyMaterial,
ย ย ย ย ย ย ย ย { name: "AES-GCM", length: 256 },
ย ย ย ย ย ย ย ย true,
ย ย ย ย ย ย ย ย ["encrypt", "decrypt"]
ย ย ย ย ย ย );
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Cifra un mensaje.
ย ย ย ย ย* @param {string} text El mensaje en texto plano.
ย ย ย ย ย* @returns {Promise<{ciphertext: string, iv: string}>} El mensaje cifrado y el IV.
ย ย ย ย ย*/
ย ย ย ย async function encryptMessage(text) {
ย ย ย ย ย ย if (!symmetricKey) throw new Error("Clave de cifrado no disponible.");

ย ย ย ย ย ย const encoder = new TextEncoder();
ย ย ย ย ย ย const data = encoder.encode(text);
ย ย ย ย ย ย const iv = crypto.getRandomValues(new Uint8Array(12)); // IV de 12 bytes para AES-GCM

ย ย ย ย ย ย const buffer = await crypto.subtle.encrypt(
ย ย ย ย ย ย ย ย { name: "AES-GCM", iv: iv },
ย ย ย ย ย ย ย ย symmetricKey,
ย ย ย ย ย ย ย ย data
ย ย ย ย ย ย );

ย ย ย ย ย ย const ciphertext = arrayBufferToBase64(buffer);
ย ย ย ย ย ย const ivString = arrayBufferToBase64(iv.buffer);

ย ย ย ย ย ย return { ciphertext, iv: ivString };
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Descifra un mensaje.
ย ย ย ย ย* @param {string} ciphertext El texto cifrado en base64.
ย ย ย ย ย* @param {string} ivString El IV en base64.
ย ย ย ย ย* @returns {Promise<string>} El mensaje descifrado en texto plano.
ย ย ย ย ย*/
ย ย ย ย async function decryptMessage(ciphertext, ivString) {
ย ย ย ย ย ย if (!symmetricKey) return "[Mensaje Cifrado - Clave Faltante]";
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const dataBuffer = base64ToArrayBuffer(ciphertext);
ย ย ย ย ย ย ย ย const ivBuffer = base64ToArrayBuffer(ivString);

ย ย ย ย ย ย ย ย const decryptedBuffer = await crypto.subtle.decrypt(
ย ย ย ย ย ย ย ย ย ย { name: "AES-GCM", iv: new Uint8Array(ivBuffer) },
ย ย ย ย ย ย ย ย ย ย symmetricKey,
ย ย ย ย ย ย ย ย ย ย dataBuffer
ย ย ย ย ย ย ย ย );

ย ย ย ย ย ย ย ย const decoder = new TextDecoder();
ย ย ย ย ย ย ย ย return decoder.decode(decryptedBuffer);
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย // Esto puede ocurrir si la clave de cifrado es incorrecta o si los datos estรกn corruptos
ย ย ย ย ย ย ย ย console.error("Error al descifrar el mensaje:", error);
ย ย ย ย ย ย ย ย return "[Error de Descifrado]";
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- Utilidades de Conversiรณn ---

ย ย ย ย function arrayBufferToBase64(buffer) {
ย ย ย ย ย ย let binary = '';
ย ย ย ย ย ย const bytes = new Uint8Array(buffer);
ย ย ย ย ย ย const len = bytes.byteLength;
ย ย ย ย ย ย for (let i = 0; i < len; i++) {
ย ย ย ย ย ย ย ย binary += String.fromCharCode(bytes[i]);
ย ย ย ย ย ย }
ย ย ย ย ย ย return btoa(binary);
ย ย ย ย }

ย ย ย ย function base64ToArrayBuffer(base64) {
ย ย ย ย ย ย const binary_string = atob(base64);
ย ย ย ย ย ย const len = binary_string.length;
ย ย ย ย ย ย const bytes = new Uint8Array(len);
ย ย ย ย ย ย for (let i = 0; i < len; i++) {
ย ย ย ย ย ย ย ย bytes[i] = binary_string.charCodeAt(i);
ย ย ย ย ย ย }
ย ย ย ย ย ย return bytes.buffer;
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* ๐ CRรTICO DE SEGURIDAD: Funciรณn de hasheo mejorada (asรญncrona con SHA-256)
ย ย ย ย ย* para no almacenar el PIN en texto plano.
ย ย ย ย ย* @param {string} pin El PIN de 4 dรญgitos.
ย ย ย ย ย* @returns {Promise<string>} El hash base64 del PIN.
ย ย ย ย ย*/
ย ย ย ย async function hashPin(pin) {
ย ย ย ย ย ย const encoder = new TextEncoder();
ย ย ย ย ย ย const data = encoder.encode(pin);
ย ย ย ย ย ย const hashBuffer = await crypto.subtle.digest('SHA-256', data);
ย ย ย ย ย ย return arrayBufferToBase64(hashBuffer);
ย ย ย ย }

ย ย ย ย // --- Flujo de la Aplicaciรณn y Estado ---

ย ย ย ย /**
ย ย ย ย ย* Muestra una alerta personalizada (reemplaza alert()).
ย ย ย ย ย* @param {string} title Tรญtulo de la alerta.
ย ย ย ย ย* @param {string} message Mensaje de la alerta.
ย ย ย ย ย*/
ย ย ย ย function customAlert(title, message) {
ย ย ย ย ย ย document.getElementById('alertTitle').innerText = title;
ย ย ย ย ย ย document.getElementById('alertMessage').innerText = message;
ย ย ย ย ย ย document.getElementById('customAlert').classList.remove('hidden');
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /**
ย ย ย ย ย* Genera un ID de 12 caracteres alfanumรฉricos.
ย ย ย ย ย* @returns {string} El cรณdigo de sala.
ย ย ย ย ย*/
ย ย ย ย function generateRoomId() {
ย ย ย ย ย ย const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
ย ย ย ย ย ย let result = '';
ย ย ย ย ย ย for (let i = 0; i < 12; i++) {
ย ย ย ย ย ย ย ย result += chars.charAt(Math.floor(Math.random() * chars.length));
ย ย ย ย ย ย }
ย ย ย ย ย ย return result;
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Navega entre las pantallas (Setup, PIN Lock, Chat).
ย ย ย ย ย*/
ย ย ย ย function showScreen(screenId) {
ย ย ย ย ย ย document.getElementById('setupScreen').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('pinLockScreen').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('chatScreen').classList.add('hidden');

ย ย ย ย ย ย document.getElementById(screenId).classList.remove('hidden');
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Inicializa la interfaz al cargar.
ย ย ย ย ย*/
ย ย ย ย async function initializeUI() {
ย ย ย ย ย ย const storedPinHash = localStorage.getItem('secureChatPinHash');
ย ย ย ย ย ย const storedRoomId = localStorage.getItem('secureChatRoomId');

ย ย ย ย ย ย if (storedPinHash && storedRoomId) {
ย ย ย ย ย ย ย ย // Usuario ya configurรณ la app: pedir PIN
ย ย ย ย ย ย ย ย pinHash = storedPinHash;
ย ย ย ย ย ย ย ย roomId = storedRoomId;
ย ย ย ย ย ย ย ย showScreen('pinLockScreen');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Primer uso: ir a la configuraciรณn
ย ย ย ย ย ย ย ย showScreen('setupScreen');
ย ย ย ย ย ย ย ย document.getElementById('roleSelection').classList.remove('hidden');
ย ย ย ย ย ย ย ย document.getElementById('hostArea').classList.add('hidden');
ย ย ย ย ย ย ย ย document.getElementById('clientArea').classList.add('hidden');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- Autenticaciรณn y Carga de la UI (Aรฑadido/Corregido) ---
ย ย ย ย onAuthStateChanged(auth, (user) => {
ย ย ย ย ย ย if (user) {
ย ย ย ย ย ย ย ย userId = user.uid;
ย ย ย ย ย ย ย ย initializeUI(); // Inicia la interfaz si el usuario estรก autenticado
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Si no hay usuario, intentar iniciar sesiรณn anรณnima
ย ย ย ย ย ย ย ย signInAnonymously(auth)
ย ย ย ย ย ย ย ย ย ย .then(() => {
ย ย ย ย ย ย ย ย ย ย ย ย // El listener se dispara de nuevo con el usuario
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย ย ย .catch((error) => {
ย ย ย ย ย ย ย ย ย ย ย ย console.error("Error al iniciar sesiรณn anรณnima:", error);
ย ย ย ย ย ย ย ย ย ย ย ย customAlert("Error de Auth", "No se pudo iniciar la sesiรณn anรณnima de Firebase. Revisa tu conexiรณn y las reglas de seguridad.");
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย });


ย ย ย ย // --- Configuraciรณn Inicial y Conexiรณn (Pantalla 2) ---

ย ย ย ย /**
ย ย ย ย ย* Configura el rol del usuario (Host o Cliente).
ย ย ย ย ย*/
ย ย ย ย window.setRole = function(role) {
ย ย ย ย ย ย document.getElementById('roleSelection').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('hostArea').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('clientArea').classList.add('hidden');

ย ย ย ย ย ย if (role === 'host') {
ย ย ย ย ย ย ย ย document.getElementById('hostArea').classList.remove('hidden');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย document.getElementById('clientArea').classList.remove('hidden');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Host: Guarda el PIN y genera el cรณdigo de sala.
ย ย ย ย ย*/
ย ย ย ย window.setupPinAndGenerateCode = async function() {
ย ย ย ย ย ย const pin = document.getElementById('hostPinInput').value;
ย ย ย ย ย ย if (pin.length !== 4 || !/^\d+$/.test(pin)) {
ย ย ย ย ย ย ย ย return customAlert("Error de PIN", "El PIN debe ser una clave numรฉrica de 4 dรญgitos.");
ย ย ย ย ย ย }

ย ย ย ย ย ย pinHash = await hashPin(pin); // Usar el hash asรญncrono
ย ย ย ย ย ย roomId = generateRoomId();

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // 1. Derivar la clave simรฉtrica
ย ย ย ย ย ย ย ย symmetricKey = await deriveKey(roomId);

ย ย ย ย ย ย ย ย // 2. Crear el documento de sala en Firestore (pรบblico)
ย ย ย ย ย ย ย ย const roomRef = doc(db, `secure_chats/${roomId}`); // Simplificado path
ย ย ย ย ย ย ย ย await setDoc(roomRef, {
ย ย ย ย ย ย ย ย ย ย hostId: userId,
ย ย ย ย ย ย ย ย ย ย createdAt: serverTimestamp(),
ย ย ย ย ย ย ย ย ย ย status: 'waiting',
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย // 3. Persistir la configuraciรณn localmente
ย ย ย ย ย ย ย ย localStorage.setItem('secureChatPinHash', pinHash);
ย ย ย ย ย ย ย ย localStorage.setItem('secureChatRoomId', roomId);

ย ย ย ย ย ย ย ย // 4. Mostrar el cรณdigo y esperar
ย ย ย ย ย ย ย ย document.getElementById('hostArea').classList.add('hidden');
ย ย ย ย ย ย ย ย document.getElementById('displayCode').innerText = roomId;
ย ย ย ย ย ย ย ย document.getElementById('hostWaitingArea').classList.remove('hidden');

ย ย ย ย ย ย ย ย // 5. Iniciar escucha de la sala
ย ย ย ย ย ย ย ย startRoomListener();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Error al generar cรณdigo y sala:", e);
ย ย ย ย ย ย ย ย customAlert("Error de Sistema", "No se pudo generar la sala. Revisa la conexiรณn y reglas de Firebase.");
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Cliente: Guarda el PIN e intenta unirse a la sala.
ย ย ย ย ย*/
ย ย ย ย window.setupPinAndJoinRoom = async function() {
ย ย ย ย ย ย const pin = document.getElementById('clientPinInput').value;
ย ย ย ย ย ย const code = document.getElementById('joinCodeInput').value.toUpperCase();

ย ย ย ย ย ย if (pin.length !== 4 || !/^\d+$/.test(pin)) {
ย ย ย ย ย ย ย ย return customAlert("Error de PIN", "Tu PIN debe ser una clave numรฉrica de 4 dรญgitos.");
ย ย ย ย ย ย }
ย ย ย ย ย ย if (code.length !== 12) {
ย ย ย ย ย ย ย ย return customAlert("Error de Cรณdigo", "El Cรณdigo รnico debe tener 12 caracteres.");
ย ย ย ย ย ย }

ย ย ย ย ย ย roomId = code;
ย ย ย ย ย ย pinHash = await hashPin(pin); // Usar el hash asรญncrono

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // 1. Derivar la clave simรฉtrica
ย ย ย ย ย ย ย ย symmetricKey = await deriveKey(roomId);

ย ย ย ย ย ย ย ย // 2. Intentar unirse (si la sala existe, actualiza el estado)
ย ย ย ย ย ย ย ย const roomRef = doc(db, `secure_chats/${roomId}`);

ย ย ย ย ย ย ย ย await runTransaction(db, async (transaction) => {
ย ย ย ย ย ย ย ย ย ย const roomDoc = await transaction.get(roomRef);

ย ย ย ย ย ย ย ย ย ย if (!roomDoc.exists() || roomDoc.data().status === 'closed' || roomDoc.data().clientId) {
ย ย ย ย ย ย ย ย ย ย ย ย throw "ROOM_NOT_FOUND";
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย // Actualiza el estado de la sala
ย ย ย ย ย ย ย ย ย ย transaction.update(roomRef, {
ย ย ย ย ย ย ย ย ย ย ย ย clientId: userId,
ย ย ย ย ย ย ย ย ย ย ย ย status: 'active', // Marca la sala como activa
ย ย ย ย ย ย ย ย ย ย ย ย joinedAt: serverTimestamp(),
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย // 3. Persistir la configuraciรณn localmente
ย ย ย ย ย ย ย ย localStorage.setItem('secureChatPinHash', pinHash);
ย ย ย ย ย ย ย ย localStorage.setItem('secureChatRoomId', roomId);

ย ย ย ย ย ย ย ย // 4. Iniciar el chat
ย ย ย ย ย ย ย ย startChatSession();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Error al unirse a la sala:", e);
ย ย ย ย ย ย ย ย document.getElementById('joinError').innerText = (e === "ROOM_NOT_FOUND") ? "Cรณdigo no encontrado, sala ya cerrada o ya con cliente." : "Error de conexiรณn. Intenta de nuevo.";
ย ย ย ย ย ย ย ย document.getElementById('joinError').classList.remove('hidden');
ย ย ย ย ย ย ย ย // Borrar clave para forzar nuevo intento
ย ย ย ย ย ย ย ย symmetricKey = null;
ย ย ย ย ย ย ย ย roomId = null;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Host: Resetea el proceso si el cรณdigo no funciona o se pierde.
ย ย ย ย ย*/
ย ย ย ย window.cancelConnectionAndReset = function() {
ย ย ย ย ย ย // Eliminar la sala antigua para evitar que alguien se conecte tarde
ย ย ย ย ย ย if (roomId) {
ย ย ย ย ย ย ย ย ยdeleteRoom(roomId);
ย ย ย ย ย ย }
ย ย ย ย ย ย // Limpiar estados y volver a empezar
ย ย ย ย ย ย pinHash = null;
ย ย ย ย ย ย symmetricKey = null;
ย ย ย ย ย ย localStorage.removeItem('secureChatPinHash');
ย ย ย ย ย ย localStorage.removeItem('secureChatRoomId');
ย ย ย ย ย ยย
ย ย ย ย ย ย // Volver a la selecciรณn de rol
ย ย ย ย ย ย document.getElementById('hostWaitingArea').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('roleSelection').classList.remove('hidden');
ย ย ย ย ย ย initializeUI();
ย ย ย ย ย ย customAlert("Cรณdigo Cancelado", "Se ha generado un nuevo Cรณdigo รnico. El anterior ya no es vรกlido.");
ย ย ย ย }

ย ย ย ย // --- Bloqueo de PIN (Pantalla 1) ---

ย ย ย ย /**
ย ย ย ย ย* Maneja el ingreso del PIN para desbloquear la aplicaciรณn.
ย ย ย ย ย*/
ย ย ย ย window.handlePinInput = async function() {
ย ย ย ย ย ย const inputPin = document.getElementById('pinInput').value;
ย ย ย ย ย ย const inputHash = await hashPin(inputPin); // Usar el hash asรญncrono

ย ย ย ย ย ย if (inputHash === pinHash && roomId) {
ย ย ย ย ย ย ย ย // Desbloqueo exitoso. Derivar la clave y cargar la sesiรณn de chat.
ย ย ย ย ย ย ย ย document.getElementById('pinError').classList.add('hidden');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย // Re-derivar la clave simรฉtrica con el roomId persistido
ย ย ย ย ย ย ย ย ย ย symmetricKey = await deriveKey(roomId);
ย ย ย ย ย ย ย ย ย ย startChatSession();
ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย console.error("Error al re-derivar la clave:", e);
ย ย ย ย ย ย ย ย ย ย // Si falla, forzar reconfiguraciรณn
ย ย ย ย ย ย ย ย ย ย resetAppAndLogout();
ย ย ย ย ย ย ย ย ย ย customAlert("Error de Cifrado", "No se pudo restaurar la sesiรณn segura. Por favor, reinicia la conexiรณn.");
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย document.getElementById('pinError').classList.remove('hidden');
ย ย ย ย ย ย ย ย document.getElementById('pinInput').value = '';
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- Chat Activo (Pantalla 3) ---

ย ย ย ย /**
ย ย ย ย ย* Inicia la sesiรณn de chat despuรฉs de la conexiรณn o desbloqueo.
ย ย ย ย ย*/
ย ย ย ย function startChatSession() {
ย ย ย ย ย ย showScreen('chatScreen');
ย ย ย ย ย ย document.getElementById('pinInput').value = '';
ย ย ย ย ย ย setupHeaderControls();
ย ย ย ย ย ย startMessagesListener();
ย ย ย ย ย ย startRoomListener();
ย ย ย ย ย ย requestNotificationPermission();
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Configura los botones de la cabecera (Bloquear/Cerrar Sesiรณn).
ย ย ย ย ย*/
ย ย ย ย function setupHeaderControls() {
ย ย ย ย ย ย const controls = document.getElementById('headerControls');
ย ย ย ย ย ย controls.innerHTML = `
ย ย ย ย ย ย ย ย <button onclick="lockApp()" class="bg-[#21262d] text-gray-300 px-3 py-1 rounded-lg border border-[#30363d] hover:bg-[#30363d] transition duration-200">
ย ย ย ย ย ย ย ย ย ย Bloquear ๐
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <button onclick="closeSessionAndWipe()" class="bg-red-700 text-white px-3 py-1 rounded-lg hover:bg-red-800 transition duration-200">
ย ย ย ย ย ย ย ย ย ย Cerrar App โ
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย `;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย // [Faltan algunas funciones de soporte necesarias para que las funciones anteriores funcionen]
ย ย ย ย 
ย ย ย ย // Funciรณn de envรญo de mensajes (agregada)
ย ย ย ย async function sendMessage() {
ย ย ย ย ย ย const input = document.getElementById('messageInput');
ย ย ย ย ย ย const text = input.value.trim();

ย ย ย ย ย ย if (text === "" || !symmetricKey || !roomId) return;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const { ciphertext, iv } = await encryptMessage(text);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย await addDoc(collection(db, `secure_chats/${roomId}/messages`), {
ย ย ย ย ย ย ย ย ย ย ciphertext,
ย ย ย ย ย ย ย ย ย ย iv,
ย ย ย ย ย ย ย ย ย ย senderId: userId,
ย ย ย ย ย ย ย ย ย ย timestamp: serverTimestamp()
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย input.value = '';
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Error al enviar mensaje:", e);
ย ย ย ย ย ย ย ย customAlert("Error de Envรญo", "No se pudo enviar el mensaje cifrado.");
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย window.sendMessage = sendMessage;


ย ย ย ย // Funciรณn para renderizar un solo mensaje (agregada)
ย ย ย ย function renderMessage(senderId, text, container) {
ย ย ย ย ย ย const isSent = senderId === userId;
ย ย ย ย ย ย 
ย ย ย ย ย ย const divFlex = document.createElement('div');
ย ย ย ย ย ย divFlex.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;

ย ย ย ย ย ย const divBubble = document.createElement('div');
ย ย ย ย ย ย divBubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
ย ย ย ย ย ย 
ย ย ย ย ย ย const pText = document.createElement('p');
ย ย ย ย ย ย pText.innerText = text;
ย ย ย ย ย ย 
ย ย ย ย ย ย divBubble.appendChild(pText);
ย ย ย ย ย ย divFlex.appendChild(divBubble);
ย ย ย ย ย ย container.appendChild(divFlex);
ย ย ย ย }

ย ย ย ย // Funciones de cierre de sesiรณn (agregadas)
ย ย ย ย function lockApp() {
ย ย ย ย ย ย showScreen('pinLockScreen');
ย ย ย ย }

ย ย ย ย async function deleteRoom(id) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย await deleteDoc(doc(db, `secure_chats/${id}`));
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error("Error al borrar la sala:", e);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function resetAppAndLogout() {
ย ย ย ย ย ย if (messagesUnsubscribe) messagesUnsubscribe();
ย ย ย ย ย ย if (roomUnsubscribe) roomUnsubscribe();
ย ย ย ย ย ย symmetricKey = null;
ย ย ย ย ย ย pinHash = null;
ย ย ย ย ย ย roomId = null;
ย ย ย ย ย ย localStorage.clear(); // Limpiar todo el estado local
ย ย ย ย ย ย initializeUI(); // Volver a la pantalla de configuraciรณn
ย ย ย ย }

ย ย ย ย async function closeSessionAndWipe() {
ย ย ย ย ย ย if (roomId) {
ย ย ย ย ย ย ย ย // Marcar la sala como cerrada y luego borrarla
ย ย ย ย ย ย ย ย await setDoc(doc(db, `secure_chats/${roomId}`), { status: 'closed' }, { merge: true });
ย ย ย ย ย ย ย ย // Opcionalmente, borrar todos los mensajes antes de borrar la sala (es mรกs complejo, lo dejamos simple)
ย ย ย ย ย ย ย ย await deleteRoom(roomId);
ย ย ย ย ย ย }
ย ย ย ย ย ย resetAppAndLogout();
ย ย ย ย }

ย ย ย ย function requestNotificationPermission() {
ย ย ย ย ย ย if ('Notification' in window && Notification.permission !== 'granted') {
ย ย ย ย ย ย ย ย Notification.requestPermission();
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function sendDisguisedNotification(decryptedText) {
ย ย ย ย ย ย if (Notification.permission === 'granted') {
ย ย ย ย ย ย ย ย // Notificaciรณn simple para no revelar el contenido en la vista previa
ย ย ย ย ย ย ย ย new Notification("Nuevo Mensaje de RED-SECURE", {
ย ย ย ย ย ย ย ย ย ย body: "Has recibido un mensaje cifrado.",
ย ย ย ย ย ย ย ย ย ย icon: '/favicon.ico' // Reemplazar con la ruta de tu icono si tienes uno
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย 
ย ย ย ย // --- Listeners de Firebase (Corregidos) ---

ย ย ย ย 
ย ย ย ย function startRoomListener() {
ย ย ย ย ย ย if (roomUnsubscribe) roomUnsubscribe();

ย ย ย ย ย ย const roomRef = doc(db, `secure_chats/${roomId}`);
ย ย ย ย ย ย roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
ย ย ย ย ย ย ย ย if (docSnap.exists()) {
ย ย ย ย ย ย ย ย ย ย const data = docSnap.data();
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย // Si el estado pasa a 'active' y el Host estaba esperando
ย ย ย ย ย ย ย ย ย ย if (data.status === 'active' && document.getElementById('hostWaitingArea').classList.contains('hidden') === false) {
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('hostWaitingArea').classList.add('hidden');
ย ย ย ย ย ย ย ย ย ย ย ย startChatSession();
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย // Si la sala se cerrรณ remotamente
ย ย ย ย ย ย ย ย ย ย if (data.status === 'closed') {
ย ย ย ย ย ย ย ย ย ย ย ย customAlert("SESIรN CERRADA", "Tu compaรฑero ha cerrado la sesiรณn. El historial de chat ha sido eliminado. Debes iniciar una nueva conexiรณn.");
ย ย ย ย ย ย ย ย ย ย ย ย resetAppAndLogout();
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Si el documento de sala ya no existe (borrado remoto)
ย ย ย ย ย ย ย ย ย ย if (roomId && (document.getElementById('chatScreen').classList.contains('hidden') === false)) {
ย ย ย ย ย ย ย ย ย ย ย ย customAlert("CONEXIรN INTERRUMPIDA", "La sala de chat fue eliminada remotamente. Por favor, reinicia la conexiรณn.");
ย ย ย ย ย ย ย ย ย ย ย ย resetAppAndLogout();
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function startMessagesListener() {
ย ย ย ย ย ย if (messagesUnsubscribe) messagesUnsubscribe();

ย ย ย ย ย ย const messagesCol = collection(db, `secure_chats/${roomId}/messages`);
ย ย ย ย ย ย const q = query(messagesCol, orderBy("timestamp", "asc"));

ย ย ย ย ย ย messagesUnsubscribe = onSnapshot(q, async (snapshot) => {
ย ย ย ย ย ย ย ย const chatArea = document.getElementById('chatArea');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const isNearBottom = chatArea.scrollHeight - chatArea.clientHeight <= chatArea.scrollTop + 10;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Limpiar mensajes antiguos (solo para fines de renderizado, no elimina de Firestore)
ย ย ย ย ย ย ย ย chatArea.innerHTML = '<div class="system-alert mb-4">Conexiรณn establecida. Cifrado AES-GCM 256 activo.</div>';

ย ย ย ย ย ย ย ย const fragment = document.createDocumentFragment();

ย ย ย ย ย ย ย ย for (const doc of snapshot.docs) { // Iterar sobre todos los documentos
ย ย ย ย ย ย ย ย ย ย ย ย const data = doc.data();
ย ย ย ย ย ย ย ย ย ย ย ย const decryptedText = await decryptMessage(data.ciphertext, data.iv);
ย ย ย ย ย ย ย ย ย ย ย ย renderMessage(data.senderId, decryptedText, fragment);
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย // Lรณgica de notificaciรณn (necesitas saber cuรกl es el รบltimo mensaje agregado)
ย ย ย ย ย ย ย ย ย ย ย ย // Si implementaste "docChanges", puedes mover la lรณgica de notificaciones allรญ.
ย ย ย ย ย ย ย ย } // <--- CIERRE DEL BUCLE FOR (ESTO FALTABA)

ย ย ย ย ย ย ย ย chatArea.appendChild(fragment);
ย ย ย ย ย ย ย ย if (isNearBottom) {
ย ย ย ย ย ย ย ย ย ย chatArea.scrollTop = chatArea.scrollHeight;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }); // <--- CIERRE DEL onSnapshot

ย ย ย ย } // <--- CIERRE DEL startMessagesListener (funciรณn)
ย ย ย ย 
ย ย </script> </body>
</html>
