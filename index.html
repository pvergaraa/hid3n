 import React, { useEffect, useState, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';

// 🔑 CONFIGURACIÓN FINAL: ESTA ES LA CONFIGURACIÓN ESTÁNDAR DE LA APP WEB DE FIREBASE.
// Se asume que la Autenticación Anónima está habilitada en la Consola.
const firebaseConfig = {
  apiKey: "AIzaSyA65iS3AUpfOGeZ_Vmi-DZXD1UHDO9l3s0", 
  authDomain: "chat-app-f6527.firebaseapp.com",
  projectId: "chat-app-f6527", // El ID de tu proyecto
  storageBucket: "chat-app-f6527.firebasestorage.app",
  messagingSenderId: "411702105463",
  appId: "1:411702105463:web:66a0c6bc69559cf190bd72"
};

const appId = firebaseConfig.projectId; // Usamos el ID del proyecto como ID de la App para la ruta de Firestore
const initialAuthToken = null; // No usamos token personalizado en el entorno de GitHub

// Utility to generate a consistent color based on userId
const generateColor = (str) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  let color = '#';
  for (let i = 0; i < 3; i++) {
    const value = (hash >> (i * 8)) & 0xFF;
    color += ('00' + value.toString(16)).substr(-2);
  }
  return color;
};

// Componente principal de la aplicación de chat
const App = () => {
  const [db, setDb] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [status, setStatus] = useState('Inicializando Firebase...');
  const messagesEndRef = useRef(null);

  // 1. Inicialización de Firebase y Autenticación
  useEffect(() => {
    // 1.1 Validación inicial de la clave (simplificada, ya que la clave está definida)
    if (!firebaseConfig.apiKey) {
      setStatus('Error: La Clave API no está definida en la configuración.');
      return;
    }

    let initializedAuth = null;
    let unsubscribeAuth = null;
    
    try {
      // 1.2 Inicialización de App
      console.log("Intentando inicializar Firebase con la configuración proporcionada...");
      const app = initializeApp(firebaseConfig);
      console.log("Firebase App inicializada con éxito.");
      
      initializedAuth = getAuth(app);
      const initializedDb = getFirestore(app);

      setDb(initializedDb);

      // 1.3 Listener para el estado de autenticación
      unsubscribeAuth = onAuthStateChanged(initializedAuth, (user) => {
        if (user) {
          setCurrentUser(user);
          setStatus(`Autenticado como: ${user.uid}`);
        } else {
          setCurrentUser(null);
          setStatus('Usuario no autenticado. Intentando iniciar sesión...');
        }
      });

      // 1.4 Lógica de inicio de sesión inicial (solo anónima)
      const signIn = async () => {
        try {
          // Intentar inicio de sesión anónima
          await signInAnonymously(initializedAuth);
        } catch (error) {
          console.error('Error de autenticación inicial:', error);
          
          let errorMessage = error.message;

          // Manejo de errores detallado
          if (error.code === 'auth/admin-restricted-operation') {
            errorMessage = "ERROR CRÍTICO: 'auth/admin-restricted-operation'. Tu cuenta o proyecto de GCP/Firebase tiene una restricción de seguridad/política que bloquea la creación de nuevos usuarios anónimos. **ACCIÓN REQUERIDA:** Asegúrate de que la Clave API no tenga restricciones en GCP o revisa las políticas de la organización.";
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = "ERROR: La autenticación anónima NO está habilitada en la consola de Firebase. Por favor, habilítala.";
          } else if (error.code === 'auth/configuration-not-found') {
            errorMessage = "ERROR CRÍTICO DE CONFIGURACIÓN: El problema es la Consola de Firebase. **ACCIÓN URGENTE REQUERIDA:** Habilitar el método de inicio de sesión **'Anonymous'** en Firebase Authentication -> Sign-in method.";
          } else if (error.code === 'auth/api-keys-are-not-supported-by-this-api') {
            errorMessage = "ERROR DE TIPO DE CLAVE: Usa la 'apiKey' que comienza con AIzaSy... de la configuración de tu App Web.";
          } else if (error.code === 'auth/api-key-not-valid') {
            errorMessage = "ERROR CRÍTICO: Clave API inválida. Asegúrate de que la clave web (AIzaSy...) esté habilitada para Identity Toolkit API.";
          }

          setStatus(`Error de Autenticación: ${errorMessage}`);
          console.log("Configuración de Firebase utilizada (Verifica estos valores):", firebaseConfig); 
        }
      };

      signIn();

      // Cleanup
      return () => {
        if (unsubscribeAuth) unsubscribeAuth();
      };
    } catch (error) {
      console.error('Error de inicialización de Firebase:', error);
      setStatus(`Error de Inicialización: ${error.message}`);
    }
  }, []);

  // 2. Escucha de Mensajes de Firestore
  useEffect(() => {
    if (db && currentUser) {
      setStatus('Cargando mensajes...');
      // Usamos la ruta de datos públicos
      const collectionPath = `/artifacts/${appId}/public/data/chat_messages`;
      const messagesCollection = collection(db, collectionPath);

      // Consulta: ordenar por la marca de tiempo (serverTimestamp)
      const q = query(messagesCollection, orderBy('timestamp', 'asc'));

      // onSnapshot para obtener actualizaciones en tiempo real
      const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
        const fetchedMessages = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setMessages(fetchedMessages);
        setStatus('Listo para chatear.');
      }, (error) => {
        console.error('Error al escuchar mensajes:', error);
        setStatus(`Error al cargar mensajes: ${error.message}`);
      });

      // Cleanup
      return () => unsubscribeSnapshot();
    }
  }, [db, currentUser]);

  // 3. Scroll al último mensaje
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // 4. Enviar Mensaje
  const handleSendMessage = useCallback(async (e) => {
    e.preventDefault();
    if (newMessage.trim() === '' || !db || !currentUser) return;

    try {
      const collectionPath = `/artifacts/${appId}/public/data/chat_messages`;
      await addDoc(collection(db, collectionPath), {
        text: newMessage,
        userId: currentUser.uid,
        timestamp: serverTimestamp(), // Usa serverTimestamp para ordenar
      });
      setNewMessage('');
    } catch (e) {
      console.error('Error al agregar documento: ', e);
      setStatus(`Error al enviar: ${e.message}`);
    }
  }, [newMessage, db, currentUser]);

  return (
    <div className="min-h-screen bg-gray-900 text-white flex flex-col font-sans p-4">
      
      {/* Header y Estado */}
      <header className="py-3 px-4 bg-gray-800 rounded-lg shadow-md mb-4 flex justify-between items-center">
        <h1 className="text-xl font-bold text-indigo-400">Secure Chat (ID de App: {appId.substring(0, 8)}...)</h1>
        <div className="text-xs text-gray-400">
            Estado: <span className="font-mono text-sm text-green-400">{status}</span>
        </div>
      </header>

      {/* Mostrar ID de Usuario */}
      {currentUser && (
        <div className="text-xs text-gray-500 mb-2 p-2 bg-gray-800 rounded-lg">
          Tu ID: <span className="font-mono text-yellow-400 break-all">{currentUser.uid}</span>
          <p className="mt-1">Comparte este ID con otros para chatear en esta sala.</p>
        </div>
      )}

      {/* Contenedor de Mensajes */}
      <div className="flex-1 overflow-y-auto space-y-3 p-4 bg-gray-800 rounded-lg shadow-inner mb-4 max-h-[70vh]">
        {messages.length === 0 && <p className="text-center text-gray-500">Aún no hay mensajes. ¡Sé el primero en saludar!</p>}
        {messages.map((msg, index) => {
          const isCurrentUser = currentUser && msg.userId === currentUser.uid;
          const userColor = generateColor(msg.userId);

          return (
            <div
              key={msg.id}
              className={`flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] ${
                  isCurrentUser
                    ? 'bg-indigo-600 text-white rounded-br-none'
                    : 'bg-gray-700 text-gray-100 rounded-tl-none'
                }`}
              >
                {!isCurrentUser && (
                  <div className="text-xs font-bold mb-1" style={{ color: userColor }}>
                    {msg.userId}
                  </div>
                )}
                <p className="text-sm break-words">{msg.text}</p>
                <div className={`text-[10px] mt-1 ${isCurrentUser ? 'text-indigo-200 text-right' : 'text-gray-400 text-left'}`}>
                  {msg.timestamp?.toDate().toLocaleTimeString() || 'Enviando...'}
                </div>
              </div>
            </div>
          );
        })}
        <div ref={messagesEndRef} />
      </div>

      {/* Formulario de Entrada */}
      <form onSubmit={handleSendMessage} className="flex space-x-2">
        <input
          type="text"
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          placeholder={currentUser ? "Escribe un mensaje..." : "Conectando al chat..."}
          disabled={!currentUser}
          className="flex-1 p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:outline-none disabled:opacity-50"
        />
        <button
          type="submit"
          disabled={!currentUser || newMessage.trim() === ''}
          className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-md shadow-indigo-500/50 disabled:bg-gray-600 disabled:shadow-none"
        >
          Enviar
        </button>
      </form>
    </div>
  );
};

export default App;
