<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RED-SECURE Chat</title>
    <script src="https://cdn.tailwindcss.com"></script> 

    </head>
            
Â <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    
    html, body {
        /* Asegura que el body ocupe todo el espacio para el centrado */
        height: 100%; 
        margin: 0;
        padding: 0;
        display: flex; /* CRÃTICO: Para centrar el contenedor */
        align-items: center;
        justify-content: center;
        background-color: #0d1117; 
        font-family: 'Inter', sans-serif;
        color: #c9d1d9;
    }
    
    .container {
        max-width: 480px;
        width: 100%;
        /* CRÃTICO: Altura fija para que no se recorte */
        height: 95vh; 
        display: flex;
        flex-direction: column;
        background-color: #161b22;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 1px solid #30363d;
        border-radius: 12px;
        overflow: hidden;
    }

    /* Aseguramos que main, donde estÃ¡n las pantallas, ocupe el espacio flexible */
    .container main {
        flex-grow: 1; 
        overflow: hidden; /* Importante para el Ã¡rea de chat */
        position: relative; /* CRÃTICO: Para que setupScreen y pinLockScreen se posicionen correctamente */
    }
    
    .chat-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px;
        scroll-behavior: smooth;
    }
    .message-bubble {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        margin-bottom: 8px;
        word-wrap: break-word;
    }
    .sent {
        background-color: #1f6feb;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }
    .received {
        background-color: #21262d;
        align-self: flex-start;
        margin-right: auto;
        border: 1px solid #30363d;
        border-bottom-left-radius: 4px;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .system-alert {
        background-color: #ff0000;
        color: #ffffff;
        font-weight: bold;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 10px auto;
        text-align: center;
        animation: pulse-red 1s infinite alternate;
    }
    @keyframes pulse-red {
        from { opacity: 0.8; }
        to { opacity: 1; }
    }
    .loader {
        border-color: #58a6ff;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
            
</head>
<body>

Â  Â  <div class="container" id="appContainer">

Â  Â  Â  Â  <header class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#1a1f26]">
Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-bold text-[#58a6ff]">:: RED-SECURE ::</h1>
Â  Â  Â  Â  Â  Â  <div id="headerControls" class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

<main class="flex-grow p-4 overflow-hidden relative">
    
    <div id="pinLockScreen" class="absolute inset-0 bg-[#161b22] z-50 flex flex-col items-center justify-center p-4 transition-opacity duration-300 hidden">
        <div class="p-8 bg-[#21262d] rounded-xl w-full max-w-sm shadow-lg border border-[#30363d] text-center">
            <h2 class="text-xl font-bold mb-4 text-[#58a6ff]">Ingreso Requerido</h2>
            <p class="mb-4 text-gray-400">Ingresa tu PIN de 4 dÃ­gitos para acceder a esta sala.</p>
            
            <input type="number" id="accessPinInput" placeholder="PIN de 4 dÃ­gitos" maxlength="4" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
            
            <button onclick="unlockApp()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                Acceder a la Sala
            </button>
            
            <button onclick="closeSessionAndWipe()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200 mt-4">
                Cerrar SesiÃ³n
            </button>
            <p id="pinError" class="text-red-400 mt-3 hidden">PIN incorrecto. Intenta de nuevo.</p>
        </div>
    </div>
    
    </main>

Â  Â  Â  Â  Â  Â  <div id="setupScreen" class="absolute inset-0 bg-[#161b22] z-40 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-8 bg-[#21262d] rounded-xl w-full max-w-sm shadow-lg border border-[#30363d]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-center text-[#58a6ff]">Establecer ConexiÃ³n Ãšnica</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="roleSelection">
    <p class="mb-4 text-center">Â¿Eres quien **genera** el cÃ³digo o quien lo **ingresa**?</p>
    <button onclick="setRole('host')" class="w-full bg-[#30363d] text-white py-3 rounded-lg font-semibold hover:bg-[#4a5057] transition duration-200 mb-3">
        Generar CÃ³digo (HOST)
    </button>
    <button onclick="setRole('client')" class="w-full bg-[#30363d] text-white py-3 rounded-lg font-semibold hover:bg-[#4a5057] transition duration-200">
        Ingresar CÃ³digo (CLIENTE)
    </button>
</div>
                    
                  <div id="hostArea" class="hidden">
    <p class="mb-3 text-center text-sm text-gray-400">Paso 1: Define tu PIN de 4 dÃ­gitos para futuros accesos.</p>
    <input type="number" id="hostPinInput" placeholder="PIN de 4 dÃ­gitos" maxlength="4" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
    
    <button onclick="setupPinAndGenerateCode()" class="w-full bg-[#1f6feb] text-white py-3 rounded-lg font-semibold hover:bg-[#1a55b3] transition duration-200">
        Guardar PIN y Generar CÃ³digo Ãšnico
    </button>
</div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="hostWaitingArea" class="hidden text-center mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-yellow-400 mb-2 font-semibold">CÃ“DIGO ÃšNICO GENERADO (COMPARTIR SOLO UNA VEZ):</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-[#0d1117] rounded-lg border border-yellow-700 flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <code id="displayCode" class="text-xl font-mono tracking-wider text-yellow-300 select-all">...</code>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="copyToClipboard(document.getElementById('displayCode').innerText)" class="ml-3 text-gray-400 hover:text-white transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-8-7l-4 4m0 0l4 4m-4-4h12"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-4">Esperando que el Cliente ingrese este cÃ³digo...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-4 inline-block"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="cancelConnectionAndReset()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Cancelar y Generar Nuevo CÃ³digo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="clientArea" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-3 text-center text-sm text-gray-400">Paso 1: Define tu PIN de 4 dÃ­gitos para futuros accesos.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="clientPinInput" placeholder="PIN de 4 dÃ­gitos" maxlength="4" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-3 text-center text-sm text-gray-400">Paso 2: Ingresa el CÃ³digo Ãšnico de 12 caracteres proporcionado.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="joinCodeInput" placeholder="CÃ³digo Ãšnico de 12 caracteres" maxlength="12" class="w-full p-3 mb-4 rounded-lg bg-[#0d1117] border border-[#30363d] text-center text-lg tracking-wider uppercase focus:ring-[#58a6ff] focus:border-[#58a6ff]" oninput="this.value = this.value.toUpperCase();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setupPinAndJoinRoom()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Conectar y Unirse al Chat
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="joinError" class="text-sm text-red-400 mt-3 text-center hidden">No se pudo encontrar el cÃ³digo o la sala.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
            
            Â  Â  Â  Â  Â  Â  <div id="chatScreen" class="h-full flex flex-col transition-opacity duration-300 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="chatArea" class="chat-area flex flex-col">
                    Â  Â  Â  Â  Â  Â  Â  Â  </div>
                Â  Â  Â  Â  Â  Â  </div>

            Â  Â  Â  Â  </main>

          
Â  Â  Â  Â  Â  Â  <div id="chatScreen" class="h-full flex flex-col transition-opacity duration-300 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="chatArea" class="chat-area flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="system-alert mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ConexiÃ³n establecida. Cifrado AES-GCM 256 activo.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 border-t border-gray-700 bg-[#1a1f26]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." class="flex-grow p-3 rounded-lg bg-[#0d1117] border border-[#30363d] text-white focus:ring-[#58a6ff] focus:border-[#58a6ff]" onkeypress="if(event.key === 'Enter') sendMessage()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="sendMessage()" class="bg-[#58a6ff] text-white px-4 py-3 rounded-lg font-semibold hover:bg-[#4a8ce6] transition duration-200 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Enviar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="customAlert" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[9999] flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-[#21262d] p-6 rounded-xl shadow-2xl border border-[#30363d] w-full max-w-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-red-400 mb-4" id="alertTitle">Alerta</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-300 mb-6" id="alertMessage">Mensaje de alerta.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('customAlert').classList.add('hidden')" class="w-full bg-[#58a6ff] text-white py-2 rounded-lg font-semibold hover:bg-[#4a8ce6]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Aceptar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // --- 1. Importaciones de Firebase (CORREGIDO: Eliminada la importaciÃ³n duplicada) ---
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, onSnapshot, collection, query, orderBy, setDoc, addDoc, serverTimestamp, deleteDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


Â  Â  Â  Â  // --- 2. ConfiguraciÃ³n de Firebase ---
Â  Â  Â  Â  // Tu configuraciÃ³n de Firebase
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyA65iS3AUpfOGeZ_Vmi-DZXD1UHDO9l3s0",
Â  Â  Â  Â  Â  Â  authDomain: "chat-app-f6527.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "chat-app-f6527",
Â  Â  Â  Â  Â  Â  storageBucket: "chat-app-f6527.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "411702105463",
Â  Â  Â  Â  Â  Â  appId: "1:411702105463:web:66a0c6bc69559cf190bd72"
Â  Â  Â  Â  };
Â  Â  Â 
Â  Â  Â  Â  // Inicializar Firebase y Servicios
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);Â 
Â  Â  Â  Â  const db = getFirestore(app);Â 
Â  Â  Â  Â  const appId = firebaseConfig.appId; // Para usar en deriveKey
Â  Â  Â  Â  setLogLevel('error');Â 

Â  Â  Â  Â  // Variables de Estado Global
Â  Â  Â  Â  let userId = null;Â 
Â  Â  Â  Â  let roomId = null;Â 
Â  Â  Â  Â  let symmetricKey = null;Â 
Â  Â  Â  Â  let pinHash = null;Â 
Â  Â  Â  Â  let messagesUnsubscribe = null;
Â  Â  Â  Â  let roomUnsubscribe = null;

Â  Â  Â  Â  // --- CriptografÃ­a (Web Crypto API) ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Deriva la clave simÃ©trica AES-GCM 256-bit usando PBKDF2.
Â  Â  Â  Â  Â * @param {string} code El cÃ³digo de 12 caracteres (PSK).
Â  Â  Â  Â  Â * @returns {Promise<CryptoKey>} La clave CryptoKey.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function deriveKey(code) {
Â  Â  Â  Â  Â  Â  const encoder = new TextEncoder();
Â  Â  Â  Â  Â  Â  // Usar el ID de la app como salt fijo (no es ideal, pero simplifica el intercambio)
Â  Â  Â  Â  Â  Â  const salt = encoder.encode(appId);Â 
Â  Â  Â  Â  Â  Â  const keyMaterial = await crypto.subtle.importKey(
Â  Â  Â  Â  Â  Â  Â  Â  "raw",
Â  Â  Â  Â  Â  Â  Â  Â  encoder.encode(code),
Â  Â  Â  Â  Â  Â  Â  Â  { name: "PBKDF2" },
Â  Â  Â  Â  Â  Â  Â  Â  false,
Â  Â  Â  Â  Â  Â  Â  Â  ["deriveKey"]
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  return crypto.subtle.deriveKey(
Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: "PBKDF2",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  salt: salt,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  iterations: 100000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hash: "SHA-256",
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  keyMaterial,
Â  Â  Â  Â  Â  Â  Â  Â  { name: "AES-GCM", length: 256 },
Â  Â  Â  Â  Â  Â  Â  Â  true,
Â  Â  Â  Â  Â  Â  Â  Â  ["encrypt", "decrypt"]
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Cifra un mensaje.
Â  Â  Â  Â  Â * @param {string} text El mensaje en texto plano.
Â  Â  Â  Â  Â * @returns {Promise<{ciphertext: string, iv: string}>} El mensaje cifrado y el IV.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function encryptMessage(text) {
Â  Â  Â  Â  Â  Â  if (!symmetricKey) throw new Error("Clave de cifrado no disponible.");

Â  Â  Â  Â  Â  Â  const encoder = new TextEncoder();
Â  Â  Â  Â  Â  Â  const data = encoder.encode(text);
Â  Â  Â  Â  Â  Â  const iv = crypto.getRandomValues(new Uint8Array(12)); // IV de 12 bytes para AES-GCM

Â  Â  Â  Â  Â  Â  const buffer = await crypto.subtle.encrypt(
Â  Â  Â  Â  Â  Â  Â  Â  { name: "AES-GCM", iv: iv },
Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey,
Â  Â  Â  Â  Â  Â  Â  Â  data
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  const ciphertext = arrayBufferToBase64(buffer);
Â  Â  Â  Â  Â  Â  const ivString = arrayBufferToBase64(iv.buffer);

Â  Â  Â  Â  Â  Â  return { ciphertext, iv: ivString };
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Descifra un mensaje.
Â  Â  Â  Â  Â * @param {string} ciphertext El texto cifrado en base64.
Â  Â  Â  Â  Â * @param {string} ivString El IV en base64.
Â  Â  Â  Â  Â * @returns {Promise<string>} El mensaje descifrado en texto plano.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function decryptMessage(ciphertext, ivString) {
Â  Â  Â  Â  Â  Â  if (!symmetricKey) return "[Mensaje Cifrado - Clave Faltante]";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataBuffer = base64ToArrayBuffer(ciphertext);
Â  Â  Â  Â  Â  Â  Â  Â  const ivBuffer = base64ToArrayBuffer(ivString);

Â  Â  Â  Â  Â  Â  Â  Â  const decryptedBuffer = await crypto.subtle.decrypt(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { name: "AES-GCM", iv: new Uint8Array(ivBuffer) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataBuffer
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  Â  Â  Â  Â  return decoder.decode(decryptedBuffer);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Esto puede ocurrir si la clave de cifrado es incorrecta o si los datos estÃ¡n corruptos
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al descifrar el mensaje:", error);
Â  Â  Â  Â  Â  Â  Â  Â  return "[Error de Descifrado]";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Utilidades de ConversiÃ³n ---

Â  Â  Â  Â  function arrayBufferToBase64(buffer) {
Â  Â  Â  Â  Â  Â  let binary = '';
Â  Â  Â  Â  Â  Â  const bytes = new Uint8Array(buffer);
Â  Â  Â  Â  Â  Â  const len = bytes.byteLength;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < len; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  binary += String.fromCharCode(bytes[i]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return btoa(binary);
Â  Â  Â  Â  }

Â  Â  Â  Â  function base64ToArrayBuffer(base64) {
Â  Â  Â  Â  Â  Â  const binary_string = atob(base64);
Â  Â  Â  Â  Â  Â  const len = binary_string.length;
Â  Â  Â  Â  Â  Â  const bytes = new Uint8Array(len);
Â  Â  Â  Â  Â  Â  for (let i = 0; i < len; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  bytes[i] = binary_string.charCodeAt(i);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return bytes.buffer;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * ğŸ›‘ CRÃTICO DE SEGURIDAD: FunciÃ³n de hasheo mejorada (asÃ­ncrona con SHA-256)
Â  Â  Â  Â  Â * para no almacenar el PIN en texto plano.
Â  Â  Â  Â  Â * @param {string} pin El PIN de 4 dÃ­gitos.
Â  Â  Â  Â  Â * @returns {Promise<string>} El hash base64 del PIN.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function hashPin(pin) {
Â  Â  Â  Â  Â  Â  const encoder = new TextEncoder();
Â  Â  Â  Â  Â  Â  const data = encoder.encode(pin);
Â  Â  Â  Â  Â  Â  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
Â  Â  Â  Â  Â  Â  return arrayBufferToBase64(hashBuffer);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Flujo de la AplicaciÃ³n y Estado ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Muestra una alerta personalizada (reemplaza alert()).
Â  Â  Â  Â  Â * @param {string} title TÃ­tulo de la alerta.
Â  Â  Â  Â  Â * @param {string} message Mensaje de la alerta.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function customAlert(title, message) {
Â  Â  Â  Â  Â  Â  document.getElementById('alertTitle').innerText = title;
Â  Â  Â  Â  Â  Â  document.getElementById('alertMessage').innerText = message;
Â  Â  Â  Â  Â  Â  document.getElementById('customAlert').classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Genera un ID de 12 caracteres alfanumÃ©ricos.
Â  Â  Â  Â  Â * @returns {string} El cÃ³digo de sala.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function generateRoomId() {
Â  Â  Â  Â  Â  Â  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
Â  Â  Â  Â  Â  Â  let result = '';
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 12; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  result += chars.charAt(Math.floor(Math.random() * chars.length));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return result;
Â  Â  Â  Â  }


        // --- FUNCIONES DE UTILDAD Y NAVEGACIÃ“N ---

// Muestra o esconde las pantallas principales
function showScreen(screenId) {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('chatScreen').classList.add('hidden');
    document.getElementById('pinLockScreen').classList.add('hidden'); // CRÃTICO: Este elemento tambiÃ©n se manipula aquÃ­
    
    // ... (resto de la funciÃ³n showScreen)
}

// Bloquea la aplicaciÃ³n (requiere PIN)
function lockApp() {
    showScreen('pinLockScreen');
}

// Desbloquea la aplicaciÃ³n
function unlockApp() { // <--- ESTA ES LA FUNCIÃ“N QUE FALTA
    const pin = document.getElementById('accessPinInput').value;
    const storedPin = localStorage.getItem('securePin');

    if (pin && pin === storedPin) {
        document.getElementById('pinError').classList.add('hidden');
        showScreen('chatScreen');
        // El resto del flujo de conexiÃ³n se maneja dentro de startChatSession o listener
    } else {
        document.getElementById('pinError').innerText = "PIN incorrecto. Intenta de nuevo.";
        document.getElementById('pinError').classList.remove('hidden');
    }
}

// ... (El resto de funciones como deleteRoom, resetAppAndLogout, closeSessionAndWipe, etc.)





        

Â  Â  Â  Â  // --- AutenticaciÃ³n y Carga de la UI (AÃ±adido/Corregido) ---
Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  initializeUI(); // Inicia la interfaz si el usuario estÃ¡ autenticado
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Si no hay usuario, intentar iniciar sesiÃ³n anÃ³nima
Â  Â  Â  Â  Â  Â  Â  Â  signInAnonymously(auth)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // El listener se dispara de nuevo con el usuario
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar sesiÃ³n anÃ³nima:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customAlert("Error de Auth", "No se pudo iniciar la sesiÃ³n anÃ³nima de Firebase. Revisa tu conexiÃ³n y las reglas de seguridad.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });


Â  Â  Â  Â  // --- ConfiguraciÃ³n Inicial y ConexiÃ³n (Pantalla 2) ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Configura el rol del usuario (Host o Cliente).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  window.setRole = function(role) {
Â  Â  Â  Â  Â  Â  document.getElementById('roleSelection').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('hostArea').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('clientArea').classList.add('hidden');

Â  Â  Â  Â  Â  Â  if (role === 'host') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('hostArea').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clientArea').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Host: Guarda el PIN y genera el cÃ³digo de sala.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  window.setupPinAndGenerateCode = async function() {
Â  Â  Â  Â  Â  Â  const pin = document.getElementById('hostPinInput').value;
Â  Â  Â  Â  Â  Â  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
Â  Â  Â  Â  Â  Â  Â  Â  return customAlert("Error de PIN", "El PIN debe ser una clave numÃ©rica de 4 dÃ­gitos.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  pinHash = await hashPin(pin); // Usar el hash asÃ­ncrono
Â  Â  Â  Â  Â  Â  roomId = generateRoomId();

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Derivar la clave simÃ©trica
Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey = await deriveKey(roomId);

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Crear el documento de sala en Firestore (pÃºblico)
Â  Â  Â  Â  Â  Â  Â  Â  const roomRef = doc(db, `secure_chats/${roomId}`); // Simplificado path
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(roomRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'waiting',
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Persistir la configuraciÃ³n localmente
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('secureChatPinHash', pinHash);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('secureChatRoomId', roomId);

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Mostrar el cÃ³digo y esperar
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('hostArea').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('displayCode').innerText = roomId;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('hostWaitingArea').classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  // 5. Iniciar escucha de la sala
Â  Â  Â  Â  Â  Â  Â  Â  startRoomListener();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al generar cÃ³digo y sala:", e);
Â  Â  Â  Â  Â  Â  Â  Â  customAlert("Error de Sistema", "No se pudo generar la sala. Revisa la conexiÃ³n y reglas de Firebase.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Cliente: Guarda el PIN e intenta unirse a la sala.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  window.setupPinAndJoinRoom = async function() {
Â  Â  Â  Â  Â  Â  const pin = document.getElementById('clientPinInput').value;
Â  Â  Â  Â  Â  Â  const code = document.getElementById('joinCodeInput').value.toUpperCase();

Â  Â  Â  Â  Â  Â  if (pin.length !== 4 || !/^\d+$/.test(pin)) {
Â  Â  Â  Â  Â  Â  Â  Â  return customAlert("Error de PIN", "Tu PIN debe ser una clave numÃ©rica de 4 dÃ­gitos.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (code.length !== 12) {
Â  Â  Â  Â  Â  Â  Â  Â  return customAlert("Error de CÃ³digo", "El CÃ³digo Ãšnico debe tener 12 caracteres.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  roomId = code;
Â  Â  Â  Â  Â  Â  pinHash = await hashPin(pin); // Usar el hash asÃ­ncrono

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Derivar la clave simÃ©trica
Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey = await deriveKey(roomId);

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Intentar unirse (si la sala existe, actualiza el estado)
Â  Â  Â  Â  Â  Â  Â  Â  const roomRef = doc(db, `secure_chats/${roomId}`);

Â  Â  Â  Â  Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const roomDoc = await transaction.get(roomRef);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!roomDoc.exists() || roomDoc.data().status === 'closed' || roomDoc.data().clientId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw "ROOM_NOT_FOUND";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Actualiza el estado de la sala
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(roomRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'active', // Marca la sala como activa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  joinedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Persistir la configuraciÃ³n localmente
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('secureChatPinHash', pinHash);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('secureChatRoomId', roomId);

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Iniciar el chat
Â  Â  Â  Â  Â  Â  Â  Â  startChatSession();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al unirse a la sala:", e);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('joinError').innerText = (e === "ROOM_NOT_FOUND") ? "CÃ³digo no encontrado, sala ya cerrada o ya con cliente." : "Error de conexiÃ³n. Intenta de nuevo.";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('joinError').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  // Borrar clave para forzar nuevo intento
Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey = null;
Â  Â  Â  Â  Â  Â  Â  Â  roomId = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Host: Resetea el proceso si el cÃ³digo no funciona o se pierde.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  window.cancelConnectionAndReset = function() {
Â  Â  Â  Â  Â  Â  // Eliminar la sala antigua para evitar que alguien se conecte tarde
Â  Â  Â  Â  Â  Â  if (roomId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â deleteRoom(roomId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Limpiar estados y volver a empezar
Â  Â  Â  Â  Â  Â  pinHash = null;
Â  Â  Â  Â  Â  Â  symmetricKey = null;
Â  Â  Â  Â  Â  Â  localStorage.removeItem('secureChatPinHash');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('secureChatRoomId');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Volver a la selecciÃ³n de rol
Â  Â  Â  Â  Â  Â  document.getElementById('hostWaitingArea').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('roleSelection').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  initializeUI();
Â  Â  Â  Â  Â  Â  customAlert("CÃ³digo Cancelado", "Se ha generado un nuevo CÃ³digo Ãšnico. El anterior ya no es vÃ¡lido.");
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Bloqueo de PIN (Pantalla 1) ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Maneja el ingreso del PIN para desbloquear la aplicaciÃ³n.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  window.handlePinInput = async function() {
Â  Â  Â  Â  Â  Â  const inputPin = document.getElementById('pinInput').value;
Â  Â  Â  Â  Â  Â  const inputHash = await hashPin(inputPin); // Usar el hash asÃ­ncrono

Â  Â  Â  Â  Â  Â  if (inputHash === pinHash && roomId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Desbloqueo exitoso. Derivar la clave y cargar la sesiÃ³n de chat.
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pinError').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Re-derivar la clave simÃ©trica con el roomId persistido
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  symmetricKey = await deriveKey(roomId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startChatSession();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al re-derivar la clave:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si falla, forzar reconfiguraciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetAppAndLogout();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customAlert("Error de Cifrado", "No se pudo restaurar la sesiÃ³n segura. Por favor, reinicia la conexiÃ³n.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pinError').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('pinInput').value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Chat Activo (Pantalla 3) ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Inicia la sesiÃ³n de chat despuÃ©s de la conexiÃ³n o desbloqueo.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function startChatSession() {
Â  Â  Â  Â  Â  Â  showScreen('chatScreen');
Â  Â  Â  Â  Â  Â  document.getElementById('pinInput').value = '';
Â  Â  Â  Â  Â  Â  setupHeaderControls();
Â  Â  Â  Â  Â  Â  startMessagesListener();
Â  Â  Â  Â  Â  Â  startRoomListener();
Â  Â  Â  Â  Â  Â  requestNotificationPermission();
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Configura los botones de la cabecera (Bloquear/Cerrar SesiÃ³n).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function setupHeaderControls() {
Â  Â  Â  Â  Â  Â  const controls = document.getElementById('headerControls');
Â  Â  Â  Â  Â  Â  controls.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="lockApp()" class="bg-[#21262d] text-gray-300 px-3 py-1 rounded-lg border border-[#30363d] hover:bg-[#30363d] transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Bloquear ğŸ”’
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeSessionAndWipe()" class="bg-red-700 text-white px-3 py-1 rounded-lg hover:bg-red-800 transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Cerrar App âŒ
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // [Faltan algunas funciones de soporte necesarias para que las funciones anteriores funcionen]
Â  Â  Â  Â  
Â  Â  Â  Â  // FunciÃ³n de envÃ­o de mensajes (agregada)
Â  Â  Â  Â  async function sendMessage() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('messageInput');
Â  Â  Â  Â  Â  Â  const text = input.value.trim();

Â  Â  Â  Â  Â  Â  if (text === "" || !symmetricKey || !roomId) return;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { ciphertext, iv } = await encryptMessage(text);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, `secure_chats/${roomId}/messages`), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ciphertext,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  iv,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  senderId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al enviar mensaje:", e);
Â  Â  Â  Â  Â  Â  Â  Â  customAlert("Error de EnvÃ­o", "No se pudo enviar el mensaje cifrado.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  window.sendMessage = sendMessage;


Â  Â  Â  Â  // FunciÃ³n para renderizar un solo mensaje (agregada)
Â  Â  Â  Â  function renderMessage(senderId, text, container) {
Â  Â  Â  Â  Â  Â  const isSent = senderId === userId;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const divFlex = document.createElement('div');
Â  Â  Â  Â  Â  Â  divFlex.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;

Â  Â  Â  Â  Â  Â  const divBubble = document.createElement('div');
Â  Â  Â  Â  Â  Â  divBubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const pText = document.createElement('p');
Â  Â  Â  Â  Â  Â  pText.innerText = text;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  divBubble.appendChild(pText);
Â  Â  Â  Â  Â  Â  divFlex.appendChild(divBubble);
Â  Â  Â  Â  Â  Â  container.appendChild(divFlex);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funciones de cierre de sesiÃ³n (agregadas)
Â  Â  Â  Â  function lockApp() {
Â  Â  Â  Â  Â  Â  showScreen('pinLockScreen');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function deleteRoom(id) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, `secure_chats/${id}`));
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al borrar la sala:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetAppAndLogout() {
Â  Â  Â  Â  Â  Â  if (messagesUnsubscribe) messagesUnsubscribe();
Â  Â  Â  Â  Â  Â  if (roomUnsubscribe) roomUnsubscribe();
Â  Â  Â  Â  Â  Â  symmetricKey = null;
Â  Â  Â  Â  Â  Â  pinHash = null;
Â  Â  Â  Â  Â  Â  roomId = null;
Â  Â  Â  Â  Â  Â  localStorage.clear(); // Limpiar todo el estado local
Â  Â  Â  Â  Â  Â  initializeUI(); // Volver a la pantalla de configuraciÃ³n
Â  Â  Â  Â  }

Â  Â  Â  Â  async function closeSessionAndWipe() {
Â  Â  Â  Â  Â  Â  if (roomId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Marcar la sala como cerrada y luego borrarla
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, `secure_chats/${roomId}`), { status: 'closed' }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  // Opcionalmente, borrar todos los mensajes antes de borrar la sala (es mÃ¡s complejo, lo dejamos simple)
Â  Â  Â  Â  Â  Â  Â  Â  await deleteRoom(roomId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  resetAppAndLogout();
Â  Â  Â  Â  }

Â  Â  Â  Â  function requestNotificationPermission() {
Â  Â  Â  Â  Â  Â  if ('Notification' in window && Notification.permission !== 'granted') {
Â  Â  Â  Â  Â  Â  Â  Â  Notification.requestPermission();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function sendDisguisedNotification(decryptedText) {
Â  Â  Â  Â  Â  Â  if (Notification.permission === 'granted') {
Â  Â  Â  Â  Â  Â  Â  Â  // NotificaciÃ³n simple para no revelar el contenido en la vista previa
Â  Â  Â  Â  Â  Â  Â  Â  new Notification("Nuevo Mensaje de RED-SECURE", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: "Has recibido un mensaje cifrado.",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: '/favicon.ico' // Reemplazar con la ruta de tu icono si tienes uno
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  
Â  Â  Â  Â  // --- Listeners de Firebase (Corregidos) ---

Â  Â  Â  Â  
Â  Â  Â  Â  function startRoomListener() {
Â  Â  Â  Â  Â  Â  if (roomUnsubscribe) roomUnsubscribe();

Â  Â  Â  Â  Â  Â  const roomRef = doc(db, `secure_chats/${roomId}`);
Â  Â  Â  Â  Â  Â  roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si el estado pasa a 'active' y el Host estaba esperando
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === 'active' && document.getElementById('hostWaitingArea').classList.contains('hidden') === false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('hostWaitingArea').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startChatSession();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si la sala se cerrÃ³ remotamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === 'closed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customAlert("SESIÃ“N CERRADA", "Tu compaÃ±ero ha cerrado la sesiÃ³n. El historial de chat ha sido eliminado. Debes iniciar una nueva conexiÃ³n.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetAppAndLogout();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si el documento de sala ya no existe (borrado remoto)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (roomId && (document.getElementById('chatScreen').classList.contains('hidden') === false)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customAlert("CONEXIÃ“N INTERRUMPIDA", "La sala de chat fue eliminada remotamente. Por favor, reinicia la conexiÃ³n.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetAppAndLogout();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function startMessagesListener() {
Â  Â  Â  Â  Â  Â  if (messagesUnsubscribe) messagesUnsubscribe();

Â  Â  Â  Â  Â  Â  const messagesCol = collection(db, `secure_chats/${roomId}/messages`);
Â  Â  Â  Â  Â  Â  const q = query(messagesCol, orderBy("timestamp", "asc"));

Â  Â  Â  Â  Â  Â  messagesUnsubscribe = onSnapshot(q, async (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const chatArea = document.getElementById('chatArea');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const isNearBottom = chatArea.scrollHeight - chatArea.clientHeight <= chatArea.scrollTop + 10;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpiar mensajes antiguos (solo para fines de renderizado, no elimina de Firestore)
Â  Â  Â  Â  Â  Â  Â  Â  chatArea.innerHTML = '<div class="system-alert mb-4">ConexiÃ³n establecida. Cifrado AES-GCM 256 activo.</div>';

Â  Â  Â  Â  Â  Â  Â  Â  const fragment = document.createDocumentFragment();

Â  Â  Â  Â  Â  Â  Â  Â  for (const doc of snapshot.docs) { // Iterar sobre todos los documentos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const decryptedText = await decryptMessage(data.ciphertext, data.iv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMessage(data.senderId, decryptedText, fragment);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica de notificaciÃ³n (necesitas saber cuÃ¡l es el Ãºltimo mensaje agregado)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si implementaste "docChanges", puedes mover la lÃ³gica de notificaciones allÃ­.
Â  Â  Â  Â  Â  Â  Â  Â  } // <--- CIERRE DEL BUCLE FOR (ESTO FALTABA)

Â  Â  Â  Â  Â  Â  Â  Â  chatArea.appendChild(fragment);
Â  Â  Â  Â  Â  Â  Â  Â  if (isNearBottom) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatArea.scrollTop = chatArea.scrollHeight;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }); // <--- CIERRE DEL onSnapshot

Â  Â  Â  Â  } // <--- CIERRE DEL startMessagesListener (funciÃ³n)
Â  Â  Â  Â  
Â  Â  </script> </body>
</html>
