// ... CONTINUACIÓN DEL ARCHIVO HTML DENTRO DE <script type="module">

        /**
         * Envía un mensaje cifrado a Firestore.
         */
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            try {
                const { ciphertext, iv } = await encryptMessage(text);
                
                const messagesCol = collection(db, `artifacts/${appId}/public/data/secure_chats/${roomId}/messages`);
                await addDoc(messagesCol, {
                    senderId: userId,
                    ciphertext: ciphertext,
                    iv: iv,
                    timestamp: serverTimestamp(),
                });
                input.value = ''; // Limpiar input
            } catch (e) {
                console.error("Error al enviar mensaje:", e);
                customAlert("Error de Envío", "No se pudo enviar el mensaje cifrado.");
            }
        }

        // --- Control de Sesión y Limpieza ---

        /**
         * Borra el documento de sala (y sus subcolecciones) de Firestore.
         */
        async function deleteRoom(id) {
            if (!id || !db) return;
            try {
                // Para borrar la subcolección 'messages' (se requiere un borrado recursivo no implementado aquí)
                // En un entorno de producción, DEBES usar Cloud Functions para borrar la subcolección
                // Aquí solo borramos el documento raíz y confiamos en la limpieza de reglas.
                const roomRef = doc(db, `artifacts/${appId}/public/data/secure_chats`, id);
                await deleteDoc(roomRef);
                console.log(`Sala ${id} marcada como cerrada.`);
            } catch (e) {
                console.error(`Error al borrar sala ${id}:`, e);
            }
        }

        /**
         * Bloquea la aplicación y vuelve a la pantalla de PIN.
         */
        window.lockApp = function() {
            showScreen('pinLockScreen');
            document.getElementById('pinInput').value = '';
            document.getElementById('pinError').classList.add('hidden');
        }

        /**
         * Cierra la sesión (cierra la sala remotamente y borra todo local).
         */
        window.closeSessionAndWipe = async function() {
            if (messagesUnsubscribe) messagesUnsubscribe();
            if (roomUnsubscribe) roomUnsubscribe();

            if (roomId) {
                // Señaliza el cierre a la otra parte y borra el historial
                await deleteRoom(roomId);
            }

            resetAppAndLogout();
            customAlert("Sesión Finalizada", "El chat ha sido cerrado y toda la información de la conexión se ha eliminado localmente.");
        }

        /**
         * Resetea el estado de la app y el usuario de Firebase.
         */
        function resetAppAndLogout() {
            localStorage.removeItem('secureChatPinHash');
            localStorage.removeItem('secureChatRoomId');
            roomId = null;
            pinHash = null;
            symmetricKey = null;
            
            if (auth) auth.signOut(); // Cierra la sesión anónima de Firebase
            
            // Limpia controles de cabecera
            document.getElementById('headerControls').innerHTML = '';
            // Vuelve a inicializar para forzar la pantalla de Setup
            initializeUI();
        }

        // --- Notificaciones ---

        /**
         * Solicita permiso para notificaciones.
         */
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                return;
            }
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        /**
         * Muestra una notificación con un texto genérico.
         */
        function sendDisguisedNotification(text) {
            if (Notification.permission === "granted") {
                new Notification(":: RED-SECURE :: Nuevo Mensaje", {
                    body: "Mensaje Recibido (Cifrado localmente).", // Disfrazar el contenido real
                    icon: './secure-icon.png' // Asume que tienes un icono de seguridad
                });
            }
        }

        // --- Inicialización de Firebase y Auth ---

        /**
         * Inicializa el SDK de Firebase y la autenticación anónima.
         */
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey) {
                    return customAlert("Configuración Crítica", "La clave de Firebase (firebaseConfig) no está definida. Es necesaria para la conexión.");
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Listener de estado de autenticación (CRÍTICO)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Autenticado como:", userId);
                        
                        // Inicia el flujo de la aplicación solo cuando hay un UID
                        initializeUI();
                    } else {
                        userId = null;
                        // Si no hay usuario, intenta iniciar sesión anónima
                        signInAnonymously(auth).catch(e => {
                            console.error("Error al iniciar sesión anónima:", e);
                            customAlert("Error de Auth", "No se pudo iniciar la sesión anónima de Firebase. Revisa tu configuración y las reglas de seguridad.");
                        });
                    }
                });

            } catch (e) {
                console.error("Error FATAL de inicialización de Firebase:", e);
                customAlert("ERROR FATAL", `No se pudo iniciar Firebase. Detalle: ${e.message}`);
            }
        }

        // --- Funciones Globales para Llamadas en el HTML ---
        // Hacemos las funciones accesibles globalmente para los atributos onclick/onkeypress en el HTML.
        window.handlePinInput = handlePinInput;
        window.setRole = setRole;
        window.setupPinAndGenerateCode = setupPinAndGenerateCode;
        window.setupPinAndJoinRoom = setupPinAndJoinRoom;
        window.cancelConnectionAndReset = cancelConnectionAndReset;
        window.sendMessage = sendMessage;
        window.customAlert = customAlert;

        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                customAlert("Copiado", "El código único ha sido copiado al portapapeles.");
            }).catch(err => {
                console.error('Error al copiar:', err);
                customAlert("Error", "No se pudo copiar el código. Intenta seleccionarlo manualmente.");
            });
        };

        // --- Arranque Inicial ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</html>
